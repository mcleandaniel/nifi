process_group:
  name: NiFi Flow
  process_groups:
    - name: BigWorkflow
      description: |
        Overview: A larger, multi-stage pipeline with nested process groups, ports, and a mix of record transforms, routing, compression, and multiple HTTP ingress groups.
        Technical: Parent orchestrates across two child groups (TransformGroup, ClassifierGroup) using input/output ports. Two additional HTTP echo groups run on ports 18082 and 18083.

      # Parent-level processors (sinks)
      processors:
        - id: src-seed
          name: Generate FlowFile (seed)
          type: org.apache.nifi.processors.standard.GenerateFlowFile
          scheduling_period: 1 min
          properties:
            Batch Size: '1'
        - id: sink-ok
          name: OK Sink
          type: org.apache.nifi.processors.standard.LogAttribute
        - id: sink-other
          name: Other Sink
          type: org.apache.nifi.processors.standard.LogAttribute

      process_groups:
        - name: TransformGroup
          input_ports:
            - id: tg-in
              name: TG IN
          output_ports:
            - id: tg-out
              name: TG OUT
          processors:
            - id: tg-update
              name: UpdateAttribute (enrich)
              type: org.apache.nifi.processors.attributes.UpdateAttribute
              properties:
                route: success
            - id: tg-convert
              name: ConvertRecord (json->csv)
              type: org.apache.nifi.processors.standard.ConvertRecord
              properties:
                Record Reader: json-reader
                Record Writer: csv-writer
            - id: tg-merge
              name: MergeRecord (3)
              type: org.apache.nifi.processors.standard.MergeRecord
              properties:
                Record Reader: csv-reader
                Record Writer: csv-writer
                Minimum Number of Records: '3'
                Maximum Number of Records: '3'
            - id: tg-compress
              name: CompressContent (gzip)
              type: org.apache.nifi.processors.standard.CompressContent
              properties:
                Compression Format: gzip
          connections:
            - name: IN to Update
              source: tg-in
              destination: tg-update
              relationships: []
            - name: Update to Convert
              source: tg-update
              destination: tg-convert
              relationships: [success]
            - name: Convert to Merge
              source: tg-convert
              destination: tg-merge
              relationships: [success]
            - name: Merge to Compress
              source: tg-merge
              destination: tg-compress
              relationships: [merged]
            - name: Compress to OUT
              source: tg-compress
              destination: tg-out
              relationships: [success]

        - name: ClassifierGroup
          input_ports:
            - id: cg-in
              name: CG IN
          output_ports:
            - id: cg-ok
              name: CG OK
            - id: cg-other
              name: CG OTHER
          processors:
            - id: cg-query
              name: QueryRecord (ok/other)
              type: org.apache.nifi.processors.standard.QueryRecord
              properties:
                record-reader: csv-reader
                record-writer: csv-writer
                ok: SELECT * FROM FLOWFILE WHERE route = 'success'
                other: SELECT * FROM FLOWFILE WHERE route <> 'success'
          connections:
            - name: IN to Query
              source: cg-in
              destination: cg-query
              relationships: []
            - name: Query to OK port
              source: cg-query
              destination: cg-ok
              relationships: [ok]
            - name: Query to OTHER port
              source: cg-query
              destination: cg-other
              relationships: [other, failure, unmatched]

        - name: HttpEcho18082
          description: Simple HTTP echo group on port 18082
          processors:
            - id: http-req-82
              name: HandleHttpRequest(18082)
              type: org.apache.nifi.processors.standard.HandleHttpRequest
              properties:
                Listening Port: '18082'
                Allowed Paths: '/echo'
                HTTP Context Map: http-context-map
            - id: http-resp-82
              name: HandleHttpResponse(18082)
              type: org.apache.nifi.processors.standard.HandleHttpResponse
              properties:
                HTTP Status Code: '204'
                Content-Type: text/plain
                HTTP Context Map: http-context-map
          connections:
            - name: 82 Request to Response
              source: http-req-82
              destination: http-resp-82
              relationships: [success]

        - name: HttpEcho18083
          description: Simple HTTP echo group on port 18083
          processors:
            - id: http-req-83
              name: HandleHttpRequest(18083)
              type: org.apache.nifi.processors.standard.HandleHttpRequest
              properties:
                Listening Port: '18083'
                Allowed Paths: '/echo'
                HTTP Context Map: http-context-map
            - id: http-resp-83
              name: HandleHttpResponse(18083)
              type: org.apache.nifi.processors.standard.HandleHttpResponse
              properties:
                HTTP Status Code: '204'
                Content-Type: text/plain
                HTTP Context Map: http-context-map
          connections:
            - name: 83 Request to Response
              source: http-req-83
              destination: http-resp-83
              relationships: [success]

      # Parent-level wiring across child groups via ports
      connections:
        - name: Seed to Transform
          source: src-seed
          destination: tg-in
          relationships: [success]
        - name: Transform to Classifier
          source: tg-out
          destination: cg-in
          relationships: []
        - name: Classifier OK to Parent OK Sink
          source: cg-ok
          destination: sink-ok
          relationships: []
        - name: Classifier OTHER to Parent Other Sink
          source: cg-other
          destination: sink-other
          relationships: []

      auto_terminate:
        sink-ok: [success]
        sink-other: [success]
