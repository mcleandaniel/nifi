process_group:
  name: NiFi Flow
  process_groups:
    - name: Tools_Trust_Create_HTTP
      description: |
        Create truststore directory via HTTP trigger. Query params: name, type (default JKS), pass.
        Flow: HandleHttpRequest (/tools/trust/create) → ExecuteStreamCommand (mkdir -p) → HandleHttpResponse.
      processors:
        - id: http-req
          name: HandleHttpRequest
          type: org.apache.nifi.processors.standard.HandleHttpRequest
          properties:
            Listening Port: "18081"
            Allowed Paths: "/tools/trust/create"
            HTTP Context Map: http-context-map
        - id: inject
          name: Inject Key
          type: org.apache.nifi.processors.attributes.UpdateAttribute
          properties:
            tools.expected.key: SET_BY_CLI
        - id: auth
          name: Auth (Groovy)
          type: org.apache.nifi.processors.script.ExecuteScript
          properties:
            Script Engine: Groovy
            Script Body: |
              import java.nio.charset.StandardCharsets
              def ff = session.get(); if(!ff) return
              def got = ff.getAttribute('http.headers.X-Tools-Key') ?: ''
              def exp = ff.getAttribute('tools.expected.key') ?: ''
              if(got != exp){
                ff = session.putAttribute(ff,'http.status','401')
                ff = session.write(ff){ os -> os.write('Unauthorized'.getBytes(StandardCharsets.UTF_8)) }
                session.transfer(ff, REL_FAILURE)
              } else {
                session.transfer(ff, REL_SUCCESS)
              }
        - id: exec
          name: Exec (create)
          type: org.apache.nifi.processors.standard.ExecuteStreamCommand
          properties:
            Command Path: /bin/bash
            Command Arguments Strategy: Command Arguments Property
            Argument Delimiter: ";"
            HTTP_QUERY: "${http.query.string}"
            Command Arguments: >-
              -lc;set -euo pipefail; TS_DIR=/opt/nifi/nifi-current/conf/truststores; mkdir -p "$TS_DIR";
              QS="${HTTP_QUERY}"; _get(){ echo "$QS" | awk -v K="$1" 'BEGIN{RS="&";FS="="} $1==K{print $2; exit}'; };
              NM=$(_get name); TY=$(_get type); [ -z "$TY" ] && TY=JKS; if [ -z "$NM" ]; then NM="<unset>"; fi;
              echo "Ensured $TS_DIR for $NM ($TY)"
            Ignore STDIN: "true"
            Working Directory: /opt/nifi
        - id: http-resp
          name: HandleHttpResponse
          type: org.apache.nifi.processors.standard.HandleHttpResponse
          properties:
            HTTP Status Code: "200"
            Content-Type: text/plain
            HTTP Context Map: http-context-map
        - id: dbg
          name: Debug Log (disabled)
          type: org.apache.nifi.processors.standard.LogAttribute
          state: DISABLED
          properties: {}
      connections:
        - source: http-req
          destination: inject
          relationships: [success]
        - source: inject
          destination: auth
          relationships: [success]
        - source: auth
          destination: exec
          relationships: [success]
        - source: auth
          destination: http-resp
          relationships: [failure]
        - source: exec
          destination: http-resp
          relationships: [output stream]
        - source: exec
          destination: dbg
          relationships: [output stream]
